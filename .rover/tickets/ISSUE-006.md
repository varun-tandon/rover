# ISSUE-006: Effect synchronizing voter status state with ref-based progress tracking

**Severity**: Medium
**Category**: State Synchronization
**Detected by**: legacy-react-purist
**File**: `src/components/App.tsx:84-93`

## Description

The code is fighting React's declarative nature. A useEffect hook (lines 85-93) is used to synchronize voterStatuses state with voterProgressRef ref values. This creates an indirect state update pattern where the ref holds the source of truth and the effect copies it to state. Additionally, line 170 in the main workflow effect directly sets voter statuses to 'voting', which is immediately overwritten by the throttled effect. This dual-update pattern indicates state synchronization anti-pattern where multiple sources try to manage the same state.

## Problematic Code

```typescript
const voterProgressRef = useRef<Map<string, number>>(new Map());
const throttledUpdateVoters = useRef(
  throttle(() => {
    setVoterStatuses(prev => prev.map(v => ({
      ...v,
      status: 'voting' as const,
      votesCompleted: voterProgressRef.current.get(v.id) ?? v.votesCompleted
    })));
  }, 300)
).current;
```

## Recommendation

Restructure to eliminate the ref-based tracking pattern. Instead, pass the setVoterStatuses setter directly to updateVoterProgress and update state immediately (with throttling if needed for performance). Alternatively, derive the voter status display directly from a single source of truth rather than synchronizing between ref and state. Consider using a reducer pattern to manage complex voter state transitions declaratively.

## Voting Summary

**Result**: 3/3 votes to approve

- **Voter 1**: Approved - "This is a genuine state synchronization anti-pattern. The code uses a ref (voterProgressRef) as the source of truth, then synchronizes it to state via a throttled effect (lines 85-93). Line 170 sets all voters to 'voting' status, which is immediately overwritten by the throttled effect on line 92 that also sets status to 'voting'. This creates unnecessary complexity and potential race conditions. The recommendation to pass setVoterStatuses directly to updateVoterProgress with throttling is sound and would eliminate the ref-state synchronization pattern, making the code more declarative and maintainable. The severity of 'medium' is appropriate as it doesn't break functionality but creates technical debt and potential bugs."
- **Voter 2**: Approved - "This is a genuine anti-pattern. The code uses a ref (voterProgressRef) as the source of truth, then synchronizes it to state via a throttled effect (lines 84-93). Line 170 sets status to 'voting' which is immediately overridden by the throttled effect. This creates unnecessary complexity and potential race conditions. The recommendation to either update state directly with throttling or use a reducer pattern is sound and would improve code maintainability and predictability. The severity 'medium' is appropriate as it works but is fragile and non-idiomatic React."
- **Voter 3**: Approved - "This is a genuine anti-pattern. The code uses a ref (voterProgressRef) as the source of truth and synchronizes it to state via a throttled effect (lines 84-93). Line 170 sets all voters to 'voting' status, which is then immediately overwritten by the throttled effect whenever it fires. This creates unnecessary complexity and potential race conditions. The recommendation to pass setVoterStatuses directly to updateVoterProgress or use a reducer pattern is sound and would simplify the code while maintaining the same throttling behavior. The severity of 'medium' is appropriate as this works but is unnecessarily complex and harder to maintain."

---
*Generated by Rover on December 12, 2025*